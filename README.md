

# üîê Symfony User Management System

## üìã Description
Syst√®me complet de gestion d'utilisateurs avec authentification, autorisation bas√©e sur des r√¥les, r√©initialisation de mot de passe, v√©rification d'email, int√©gration reCAPTCHA et notifications SMS/Email.

## üõ†Ô∏è Technologies & Bundles Utilis√©s

### Framework & Core
- **Symfony 6.x** - Framework PHP
- **Doctrine ORM** - Gestion de base de donn√©es
- **Twig** - Moteur de templates

### Bundles de S√©curit√©
- **symfony/security-bundle** - Authentification et autorisation
- **symfonycasts/reset-password-bundle** - R√©initialisation de mot de passe
- **symfonycasts/verify-email-bundle** - V√©rification d'email
- **scheb/2fa-bundle** - Authentification √† deux facteurs

### Validation & Formulaires
- **symfony/form** - Gestion des formulaires
- **symfony/validator** - Validation des donn√©es
- **google/recaptcha** - Protection reCAPTCHA

### Communication
- **symfony/mailer** - Envoi d'emails
- **twilio/sdk** - Notifications SMS

### D√©veloppement
- **symfony/maker-bundle** - G√©n√©rateurs de code
- **sensio/framework-extra-bundle** - Annotations et fonctionnalit√©s suppl√©mentaires

## üéØ Fonctionnalit√©s Principales

### üîë Authentification & Autorisation
- **Login/Logout** avec gestion de sessions
- **Inscription** avec validation compl√®te
- **Syst√®me de r√¥les** (SUPER_ADMIN, ADMIN, USER)
- **Authentification √† 2 facteurs** (2FA) par email
- **V√©rification d'email** obligatoire

### üë• Gestion des Utilisateurs (CRUD)
- **Cr√©ation** d'utilisateurs par les admins
- **Lecture** avec filtrage par r√¥les et exclusion de l'utilisateur connect√©
- **Modification** avec restrictions de permissions
- **Suppression** avec confirmation
- **Blocage/D√©blocage** d'utilisateurs
- **Photo de profil** via URL dans la page profile

### üñºÔ∏è Gestion des Profils
- **Page profile centr√©e** avec design moderne
- **Upload de photo de profil** par URL
- **Pr√©visualisation** en temps r√©el de l'image
- **Mise √† jour** dynamique de la photo dans l'en-t√™te
- **Formulaire responsive** avec validation c√¥t√© client

### üîí S√©curit√© Avanc√©e
- **R√©initialisation de mot de passe** s√©curis√©e
- **Protection reCAPTCHA** sur les formulaires sensibles
- **Validation de tokens CSRF**
- **Hachage s√©curis√©** des mots de passe

### üìß Notifications
- **Emails** de v√©rification et r√©initialisation
- **SMS** via Twilio pour notifications importantes
- **Templates** personnalis√©s pour tous les emails

## üèóÔ∏è Architecture du Projet

### üìÅ Structure des Fichiers

```
src/
‚îú‚îÄ‚îÄ Controller/
‚îÇ   ‚îú‚îÄ‚îÄ AdminController.php          # Gestion espace admin
‚îÇ   ‚îú‚îÄ‚îÄ ClientController.php         # Espace client (USER)
‚îÇ   ‚îú‚îÄ‚îÄ RegistrationController.php   # Inscription utilisateurs
‚îÇ   ‚îú‚îÄ‚îÄ ResetPasswordController.php  # R√©initialisation mot de passe
‚îÇ   ‚îú‚îÄ‚îÄ SecurityController.php       # Login/Logout
‚îÇ   ‚îî‚îÄ‚îÄ UserController.php           # CRUD utilisateurs
‚îú‚îÄ‚îÄ Entity/
‚îÇ   ‚îú‚îÄ‚îÄ User.php                     # Entit√© utilisateur principal
‚îÇ   ‚îî‚îÄ‚îÄ ResetPasswordRequest.php     # Tokens de r√©initialisation
‚îú‚îÄ‚îÄ Form/
‚îÇ   ‚îú‚îÄ‚îÄ LoginFormType.php            # Formulaire de connexion
‚îÇ   ‚îú‚îÄ‚îÄ RegistrationFormType.php     # Formulaire d'inscription
‚îÇ   ‚îú‚îÄ‚îÄ UserType.php                 # Formulaire CRUD utilisateur
‚îÇ   ‚îú‚îÄ‚îÄ ProfileType.php              # Modification profil
‚îÇ   ‚îú‚îÄ‚îÄ ChangePasswordFormType.php   # Changement mot de passe
‚îÇ   ‚îî‚îÄ‚îÄ ResetPasswordRequestFormType.php # Demande reset password
‚îú‚îÄ‚îÄ Repository/
‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.php           # Requ√™tes personnalis√©es
‚îÇ   ‚îî‚îÄ‚îÄ ResetPasswordRequestRepository.php
‚îú‚îÄ‚îÄ Security/
‚îÇ   ‚îú‚îÄ‚îÄ AppAuthenticator.php         # Authentificateur principal
‚îÇ   ‚îî‚îÄ‚îÄ EmailVerifier.php            # V√©rification emails
‚îú‚îÄ‚îÄ Service/
‚îÇ   ‚îî‚îÄ‚îÄ SmsService.php               # Service notifications SMS
‚îî‚îÄ‚îÄ EventListener/
    ‚îî‚îÄ‚îÄ LoginListener.php            # √âv√©nements de connexion

templates/
‚îú‚îÄ‚îÄ base.html.twig                   # Template de base
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ index.html.twig              # Dashboard admin
‚îÇ   ‚îî‚îÄ‚îÄ please-verify-email.html.twig
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îî‚îÄ‚îÄ dashboard.html.twig          # Espace client
‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îî‚îÄ‚îÄ login.html.twig              # Page de connexion
‚îú‚îÄ‚îÄ registration/
‚îÇ   ‚îú‚îÄ‚îÄ register.html.twig           # Page d'inscription
‚îÇ   ‚îî‚îÄ‚îÄ confirmation_email.html.twig
‚îú‚îÄ‚îÄ reset_password/
‚îÇ   ‚îú‚îÄ‚îÄ request.html.twig            # Demande reset
‚îÇ   ‚îú‚îÄ‚îÄ check_email.html.twig        # V√©rification email
‚îÇ   ‚îî‚îÄ‚îÄ reset.html.twig              # Nouveau mot de passe
‚îî‚îÄ‚îÄ user/
    ‚îú‚îÄ‚îÄ index.html.twig              # Liste utilisateurs
    ‚îú‚îÄ‚îÄ new.html.twig                # Cr√©ation utilisateur
    ‚îú‚îÄ‚îÄ edit.html.twig               # Modification utilisateur
    ‚îî‚îÄ‚îÄ _form.html.twig              # Formulaire r√©utilisable

config/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ security.yaml                # Configuration s√©curit√©
‚îÇ   ‚îú‚îÄ‚îÄ doctrine.yaml                # Configuration BDD
‚îÇ   ‚îú‚îÄ‚îÄ mailer.yaml                  # Configuration emails
‚îÇ   ‚îú‚îÄ‚îÄ recaptcha.yaml               # Configuration reCAPTCHA
‚îÇ   ‚îî‚îÄ‚îÄ scheb_2fa.yaml               # Configuration 2FA
‚îî‚îÄ‚îÄ routes.yaml                      # Routes principales
```

## üöÄ Installation & Configuration

### Pr√©requis
- **PHP 8.1+**
- **Composer**
- **MySQL/MariaDB**
- **Compte SMTP** (Gmail, Mailtrap, etc.)
- **Compte Twilio** (pour SMS)
- **Cl√©s reCAPTCHA Google**

### 1. Clonage du Projet
```bash
git clone 
cd AuthUserManagement
```

### 2. Installation des D√©pendances
```bash
composer install
```

### 3. Configuration de l'Environnement
Cr√©er un fichier `.env.local` et configurer :

```env
# Base de donn√©es
DATABASE_URL="mysql://username:password@127.0.0.1:3306/ratrappage"

# Mailer SMTP
MAILER_DSN=smtp://username:password@smtp.gmail.com:587

# Twilio (SMS)
TWILIO_SID=your_twilio_sid
TWILIO_TOKEN=your_twilio_token
TWILIO_FROM=your_twilio_phone_number

# reCAPTCHA
RECAPTCHA_SITE_KEY=your_site_key
RECAPTCHA_SECRET_KEY=your_secret_key
```

### 4. Configuration de la Base de Donn√©es
```bash
# Cr√©er la base de donn√©es
php bin/console doctrine:database:create

# Appliquer les migrations
php bin/console doctrine:migrations:migrate

# Ou utiliser schema:update si probl√®me avec migrations
php bin/console doctrine:schema:update --force
```

### 5. Cr√©ation du Super Admin
Ex√©cuter cette requ√™te SQL directement dans votre base de donn√©es :

```sql
INSERT INTO user (email, roles, password, name, phone_number, is_blocked, is_verified, created_at) 
VALUES (
    'superadmin@admin.com', 
    '["ROLE_SUPER_ADMIN"]', 
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 
    'Super Admin', 
    '12345678', 
    0, 
    1, 
    NOW()
);
```

**Identifiants Super Admin :**
- Email : `superadmin@admin.com`
- Mot de passe : `password`

### 6. Lancement du Serveur
```bash
# Vider le cache
php bin/console cache:clear

# D√©marrer le serveur
symfony serve
# Ou
php -S localhost:8000 -t public/
```

## üîê Syst√®me de R√¥les et Permissions

### ROLE_SUPER_ADMIN
- **Acc√®s complet** √† toutes les fonctionnalit√©s
- **Cr√©ation** d'utilisateurs ADMIN et USER
- **Modification/Suppression** de tous les utilisateurs
- **Gestion** des permissions et r√¥les

### ROLE_ADMIN
- **Acc√®s** aux fonctionnalit√©s d'administration
- **Visualisation** uniquement des utilisateurs avec ROLE_USER
- **Cr√©ation/Modification** uniquement des ROLE_USER
- **Impossibilit√©** de g√©rer d'autres admins

### ROLE_USER (Client)
- **Acc√®s** √† l'espace client personnel
- **Modification** de son propre profil avec photo
- **Aucun acc√®s** aux fonctionnalit√©s d'administration

## üîß Fonctionnalit√©s Techniques Avanc√©es

### Exclusion de l'Utilisateur Connect√©
Pour √©viter la redondance, l'utilisateur connect√© ne voit pas son propre compte dans la liste des utilisateurs :

**Impl√©mentation dans UserController :**
```php
// SUPER_ADMIN voit tous les utilisateurs sauf lui-m√™me
$users = $userRepository->findAllExceptCurrentUser($currentUser->getId());

// ADMIN voit seulement les clients sauf lui-m√™me  
$users = $userRepository->findUsersByRoleExceptCurrent('ROLE_USER', $currentUser->getId());
```

**Nouvelles m√©thodes dans UserRepository :**
```php
public function findAllExceptCurrentUser(int $currentUserId): array
public function findUsersByRoleExceptCurrent(string $role, int $currentUserId): array
```

### Gestion des Photos de Profil
- **Stockage URL** dans la base de donn√©es (champ `image` de type string)
- **Pr√©visualisation JavaScript** en temps r√©el
- **Validation c√¥t√© client** avec fallback en cas d'erreur
- **Interface centr√©e** avec design moderne responsive

## üõ£Ô∏è Routes Principales

```
/ (app_login)                    - Page de connexion
/register (app_register)         - Inscription
/logout (app_logout)             - D√©connexion

/admin (app_admin)               - Dashboard admin
/client (app_client_dashboard)   - Espace client

/user (app_user_index)           - Liste utilisateurs
/user/new (app_user_new)         - Cr√©er utilisateur
/user/{id}/edit (app_user_edit)  - Modifier utilisateur
/user/{id} (app_user_delete)     - Supprimer utilisateur

/reset-password (app_forgot_password_request) - Demande reset
/reset-password/reset (app_reset_password)    - Reset password
```

## üîß Commandes Utiles

```bash
# Vider le cache
php bin/console cache:clear

# Voir les routes
php bin/console debug:router

# Voir les utilisateurs
php bin/console doctrine:query:sql "SELECT * FROM user"

# G√©n√©rer un nouveau contr√¥leur
php bin/console make:controller

# G√©n√©rer un CRUD complet
php bin/console make:crud

# Cr√©er une migration
php bin/console make:migration

# Appliquer les migrations
php bin/console doctrine:migrations:migrate
```

## üìù Fonctionnalit√©s D√©taill√©es

### üîê Contr√¥le de Saisie & Validation
- **Validation email** avec contraintes Symfony
- **Validation mot de passe** (longueur minimum)
- **Validation t√©l√©phone** (8 chiffres exactement)
- **Protection CSRF** sur tous les formulaires
- **reCAPTCHA** sur inscription et login

### üìß Syst√®me de Mailing
- **Emails de v√©rification** apr√®s inscription
- **Emails de r√©initialisation** de mot de passe
- **Templates Twig** personnalis√©s
- **Configuration SMTP** flexible

### üì± Notifications SMS (Twilio)
- **Codes de v√©rification** 2FA
- **Notifications** importantes
- **Configuration** via variables d'environnement

### üîÑ Reset Password
- **Tokens s√©curis√©s** avec expiration
- **Liens uniques** par utilisateur
- **Validation** c√¥t√© serveur
- **Emails automatiques**

## üêõ D√©pannage

### Probl√®mes Courants

1. **Erreur de migration**
   ```bash
   php bin/console doctrine:schema:update --force
   ```

2. **Probl√®me de cache**
   ```bash
   php bin/console cache:clear --env=dev
   ```

3. **Erreur de permissions**
   ```bash
   chmod -R 775 var/
   ```

4. **Test des emails**
   - Utiliser Mailtrap pour tester en d√©veloppement
   - V√©rifier la configuration SMTP dans `.env.local`

## üìö Documentation Additionnelle

- [Symfony Security](https://symfony.com/doc/current/security.html)
- [Doctrine ORM](https://www.doctrine-project.org/projects/orm.html)
- [Twig Templates](https://twig.symfony.com/doc/3.x/)
- [SymfonyCasts Bundles](https://symfonycasts.com/)

## üë®‚Äçüíª D√©velopp√© par
**rayen ben dhia ** - Syst√®me de gestion d'utilisateurs avec authentification avanc√©e

---
*Ce projet d√©montre l'impl√©mentation compl√®te d'un syst√®me d'authentification et d'autorisation robuste avec Symfony.*
